name: Copilot Maintainer Loop

on:
  issues:
    types: [opened, edited]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  maintainer-action:
    # Filter out bot accounts to prevent infinite loops
    if: github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Set Environment Variables
        run: |
          # Unify Issue/PR ID for tracking
          ID="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "ISSUE_ID=$ID" >> $GITHUB_ENV
          
          # Determine if context is a PR or a new Issue
          if [ "${{ github.event_name }}" == "pull_request_review" ] || [ -n "${{ github.event.pull_request }}" ]; then
            echo "MODE=PR" >> $GITHUB_ENV
            echo "BRANCH_NAME=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
          else
            echo "MODE=ISSUE" >> $GITHUB_ENV
            echo "BRANCH_NAME=fix/issue-$ID" >> $GITHUB_ENV
          fi

      - name: Run Maintainer Agent Logic
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_CONTEXT: ${{ github.event.issue.body || github.event.pull_request.title }}
          REVIEW_FEEDBACK: ${{ github.event.review.body || github.event.comment.body }}
        run: |
          # Switch to the appropriate branch based on the mode
          if [ "$MODE" == "ISSUE" ]; then
            git checkout -b $BRANCH_NAME
          else
            git checkout $BRANCH_NAME
          fi

          # Call the Copilot Agent to analyze and fix code based on the instructions
          gh copilot suggest \
            --agent-file .github/agents/maintainer.agent.md \
            --context "$ISSUE_CONTEXT" \
            --feedback "$REVIEW_FEEDBACK" \
            --run-tests "npm test"

      - name: Commit and Push Changes
        id: git-push
        run: |
          # Only proceed if files were changed by the agent
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            # Ensure commit message includes the issue number for traceability
            git commit -m "fix: address issue #$ISSUE_ID and feedback"
            git push origin $BRANCH_NAME
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Pull Request
        if: steps.git-push.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "$MODE" == "ISSUE" ]; then
            # Check if a PR already exists for this branch
            PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')
            
            if [ -z "$PR_EXISTS" ]; then
              # Auto-link the Issue using 'Closes #ID' in the PR body
              gh pr create \
                --title "fix: solve issue #$ISSUE_ID" \
                --body "## Summary
                This PR automatically resolves #$ISSUE_ID.
                
                Closes #$ISSUE_ID
                
                ## Changes
                - Applied fixes via Maintainer Agent
                - Verified with npm test
                
                ## FE Exam Insight
                Please check the automated explanation below for exam preparation." \
                --head "$BRANCH_NAME" \
                --base main
            fi
          else
            # Notify on existing PR that feedback has been addressed
            gh pr comment ${{ github.event.pull_request.number }} --body "Applied fixes based on your feedback and verified tests. Please review again. (#$ISSUE_ID)"
          fi
