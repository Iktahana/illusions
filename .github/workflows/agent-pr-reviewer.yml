name: Copilot PR Reviewer

on:
  pull_request:
    types: [opened] # Only on open, not synchronize (avoid comment spam)

permissions:
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Review Available
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPO=${{ github.repository }}
          PR_NUM=${{ github.event.pull_request.number }}

          # Dedup: skip if bot already commented on this PR
          EXISTING=$(gh pr view "$PR_NUM" --repo "$REPO" --json comments --jq \
            '[.comments[] | select(.body | contains("Copilot Review Ready"))] | length')

          if [ "$EXISTING" != "0" ]; then
            echo "Review comment already exists, skipping."
            exit 0
          fi

          gh pr comment "$PR_NUM" --repo "$REPO" --body "$(cat <<'EOF'
          ðŸ‘‹ **Copilot Review Ready**

          ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã«ã¯ã€GitHub Copilot Chat ã§ `@reviewer` ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ï¼š

          ```
          @reviewer ã“ã® PR ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„
          ```

          **ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–ï¼š**
          - âœ… ãƒ‡ãƒ¼ã‚¿ç ´æã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ
          - âš ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®è»½å¾®ãªæ”¹å–„ææ¡ˆ
          - âŒ ã‚¹ã‚¿ã‚¤ãƒ«ã®å¥½ã¿ã€äº›ç´°ãªãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆï¼ˆæŒ‡æ‘˜ã—ã¾ã›ã‚“ï¼‰
          EOF
          )"
