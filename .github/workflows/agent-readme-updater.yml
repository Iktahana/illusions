name: "Update README"

on:
  push:
    branches: [main]
    paths-ignore:
      - "README.md"
      - "docs/**"
      - "www/**"
      - ".github/workflows/**"
      - "*.md"

permissions:
  contents: read
  issues: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    # Prevent recursive triggers from the bot's own commits
    if: github.actor != 'github-actions[bot]' && github.actor != 'copilot-swe-agent[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Collect recent changes
        id: changes
        run: |
          COMMITS=$(git log --oneline -10)
          DIFF_STAT=$(git diff --stat HEAD~5 -- '*.ts' '*.tsx' 'package.json' 2>/dev/null || echo "No diff available")

          # Write to multiline output
          {
            echo "commits<<COMMITS_EOF"
            echo "$COMMITS"
            echo "COMMITS_EOF"
            echo "diff_stat<<DIFF_EOF"
            echo "$DIFF_STAT"
            echo "DIFF_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create issue for Copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Close any existing open README update issues to avoid duplicates
          gh issue list \
            --label "copilot" \
            --label "documentation" \
            --state open \
            --json number \
            --jq '.[].number' | while read -r num; do
            gh issue close "$num" --comment "Superseded by a newer push." || true
          done

          # Create a new issue and assign Copilot
          gh issue create \
            --title "docs: update README.md to reflect recent changes" \
            --label "copilot,documentation" \
            --body "$(cat <<'EOF'
          ## Task

          Update `README.md` to reflect the latest code changes pushed to `main`.

          ## Recent Commits

          ```
          ${{ steps.changes.outputs.commits }}
          ```

          ## Changed Files

          ```
          ${{ steps.changes.outputs.diff_stat }}
          ```

          ## Instructions

          Follow the instructions in `.github/agents/readme-updater.agent.md`:

          1. Read the diff of the recent commits listed above.
          2. Determine if any user-facing features were added, removed, or changed.
          3. If changes are docs-only or internal refactoring with no user-facing impact, close this issue with "No README update needed".
          4. Otherwise, make **minimal, surgical edits** to `README.md` â€” do NOT rewrite the entire file.
          5. Commit with message: `docs: update README to reflect recent changes`

          **Language rules**: English and Japanese only. No Chinese or Korean.
          EOF
          )"
