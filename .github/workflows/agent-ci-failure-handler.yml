name: CI Failure Handler

on:
  workflow_run:
    workflows: ["Desktop Build and Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: '分析したい Workflow Run ID (空欄の場合は直近の失敗を分析)'
        required: false
        default: ''

permissions:
  contents: read
  issues: write

jobs:
  on-failure:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'failure' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Determine Workflow Run ID
        id: info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT_ID="${{ github.event.inputs.run_id }}"
            if [ -z "$INPUT_ID" ]; then
              RUN_ID=$(gh run list --status failure --limit 1 --json databaseId --jq '.[0].databaseId')
            else
              RUN_ID=$INPUT_ID
            fi
          else
            RUN_ID=${{ github.event.workflow_run.id }}
          fi
          echo "RUN_ID=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Check for duplicate issue
        id: dedup
        env:
          GH_TOKEN: ${{ github.token }}
          WORKFLOW_ID: ${{ steps.info.outputs.RUN_ID }}
        run: |
          # Search for open issues that already reference this run ID
          COUNT=$(gh issue list --state open --search "Run #$WORKFLOW_ID" --json number --jq 'length')
          if [ "$COUNT" != "0" ]; then
            echo "Issue already exists for Run #$WORKFLOW_ID, skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Analyze logs and create issue
        if: steps.dedup.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          WORKFLOW_ID: ${{ steps.info.outputs.RUN_ID }}
          REPO: ${{ github.repository }}
        run: |
          echo "Fetching logs for workflow run: $WORKFLOW_ID"

          gh run view "$WORKFLOW_ID" --log-failed > failure_log.txt 2>&1 || true

          if [ ! -s failure_log.txt ]; then
            echo "ログが空のため、Issue の作成をスキップします。"
            exit 0
          fi

          # Extract error lines and surrounding context
          ERROR_LINES=$(grep -A 3 "##\[error\]" failure_log.txt | head -n 40 || true)
          LOG_TAIL=$(tail -n 60 failure_log.txt | head -n 50)

          # Get workflow metadata
          WORKFLOW_NAME=$(gh run view "$WORKFLOW_ID" --json name --jq '.name' 2>/dev/null || echo "Unknown")
          COMMIT_MSG="${{ github.event.workflow_run.head_commit.message }}"

          # Ensure labels exist (create if missing)
          gh label create "ci-failure" --color "D73A49" --description "CI/CD failure" 2>/dev/null || true

          BODY=$(cat <<BODY_EOF
          ## CI ビルドが失敗しました

          **Workflow**: \`$WORKFLOW_NAME\`
          **Run ID**: [#$WORKFLOW_ID](https://github.com/$REPO/actions/runs/$WORKFLOW_ID)
          **Commit**: $COMMIT_MSG

          ---

          ## エラーログ

          \`\`\`
          $ERROR_LINES
          \`\`\`

          <details>
          <summary>ログ末尾（詳細）</summary>

          \`\`\`
          $LOG_TAIL
          \`\`\`

          </details>

          [完全なログを確認](https://github.com/$REPO/actions/runs/$WORKFLOW_ID)

          ---

          *この Issue は CI Failure Handler により自動作成されました。*
          BODY_EOF
          )

          gh issue create \
            --title "CI Failure: $WORKFLOW_NAME (Run #$WORKFLOW_ID)" \
            --label "ci-failure" \
            --body "$BODY"
