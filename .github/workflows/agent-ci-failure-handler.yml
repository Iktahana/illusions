name: CI Failure Handler

on:
  workflow_run:
    workflows: ["Deploy www to GitHub Pages", "Desktop Build and Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'åˆ†æã—ãŸã„ Workflow Run ID (ç©ºæ¬„ã®å ´åˆã¯ç›´è¿‘ã®å¤±æ•—ã‚’åˆ†æ)'
        required: false
        default: ''

permissions:
  contents: read
  issues: write

jobs:
  on-failure:
    runs-on: ubuntu-latest
    # è‡ªå‹•å®Ÿè¡Œã§å¤±æ•—ã—ãŸå ´åˆã€ã¾ãŸã¯æ‰‹å‹•ã§ãƒˆãƒªã‚¬ãƒ¼ã—ãŸå ´åˆã«å®Ÿè¡Œ
    if: >
      github.event.workflow_run.conclusion == 'failure' || 
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine Workflow Run ID
        id: info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT_ID="${{ github.event.inputs.run_id }}"
            if [ -z "$INPUT_ID" ]; then
              # IDãŒæœªæŒ‡å®šã®å ´åˆã€ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§ç›´è¿‘ã«å¤±æ•—ã—ãŸ Run ID ã‚’å–å¾—
              RUN_ID=$(gh run list --status failure --limit 1 --json databaseId --jq '.[0].databaseId')
            else
              RUN_ID=$INPUT_ID
            fi
          else
            RUN_ID=${{ github.event.workflow_run.id }}
          fi
          echo "RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Analyze Logs and Create Issue
        env:
          GH_TOKEN: ${{ github.token }}
          WORKFLOW_ID: ${{ steps.info.outputs.RUN_ID }}
          REPO: ${{ github.repository }}
        run: |
          echo "Fetching logs for workflow run: $WORKFLOW_ID"

          # å¤±æ•—ã—ãŸã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ­ã‚°ã‚’å–å¾—
          gh run view $WORKFLOW_ID --log-failed > failure_log.txt || echo "Failed logs could not be retrieved." > failure_log.txt

          if [ ! -s failure_log.txt ]; then
            echo "ãƒ­ã‚°ãŒç©ºã®ãŸã‚ã€Issueã®ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi

          # ãƒ­ã‚°ã®ä¸­é–“100è¡Œã‚’æŠ½å‡ºï¼ˆå†’é ­ã¯ãƒã‚¤ã‚ºãŒå¤šã„ãŸã‚ï¼‰
          LOG_SUMMARY=$(cat failure_log.txt | tail -n 200 | head -n 100)

          # Workflowåã‚’å–å¾—
          WORKFLOW_NAME=$(gh run view $WORKFLOW_ID --json name --jq '.name')

          gh issue create \
            --title "ğŸš¨ CI Failure: $WORKFLOW_NAME (Run #$WORKFLOW_ID)" \
            --label "bug,ci-failure" \
            --body "## ğŸ”´ CI ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ

          **Workflow**: \`$WORKFLOW_NAME\`
          **Run ID**: [$WORKFLOW_ID](https://github.com/$REPO/actions/runs/$WORKFLOW_ID)
          **Triggered by**: ${{ github.event.workflow_run.head_commit.message }}

          ---

          ## ğŸ“‹ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆæŠœç²‹ï¼‰

          \`\`\`
          $LOG_SUMMARY
          \`\`\`

          [ğŸ“„ å®Œå…¨ãªãƒ­ã‚°ã‚’ç¢ºèª](https://github.com/$REPO/actions/runs/$WORKFLOW_ID)

          ---

          ## ğŸ¤– AI ã«ã‚ˆã‚‹è¨ºæ–­ã‚’å®Ÿè¡Œ

          GitHub Copilot Chat ã§ \`@ci-debugger\` ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦è©³ç´°ãªåˆ†æã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š

          **VS Code / GitHub.com ã§ï¼š**
          \`\`\`
          @ci-debugger Run #$WORKFLOW_ID ã®å¤±æ•—åŸå› ã‚’åˆ†æã—ã¦ã€ä¿®æ­£æ–¹æ³•ã‚’ææ¡ˆã—ã¦ãã ã•ã„
          \`\`\`

          **ã¾ãŸã¯ï¼š**
          \`\`\`
          @ci-debugger ã“ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è§£æã—ã¦ãã ã•ã„:
          [ãƒ­ã‚°ã®ã‚¨ãƒ©ãƒ¼éƒ¨åˆ†ã‚’è²¼ã‚Šä»˜ã‘]
          \`\`\`

          ---

          ## ğŸ› ï¸ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

          1. **ãƒ­ã‚°ã‚’ç¢ºèª**: ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å®Œå…¨ãªãƒ­ã‚°ã‚’ç¢ºèª
          2. **ã‚¨ãƒ©ãƒ¼ã‚’ç‰¹å®š**: \`##[error]\` ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¤œç´¢
          3. **AIè¨ºæ–­**: \`@ci-debugger\` ã§æ ¹æœ¬åŸå› ã‚’åˆ†æ
          4. **ä¿®æ­£ã‚’å®Ÿè£…**: \`@maintainer\` ã§è‡ªå‹•ä¿®æ­£ã‚’è©¦è¡Œï¼ˆç°¡å˜ãªå ´åˆï¼‰
          5. **å†å®Ÿè¡Œ**: ä¿®æ­£å¾Œã€workflow ã‚’å†å®Ÿè¡Œ

          ---

          **Note**: ã“ã® Issue ã¯ CI Failure Handler ã«ã‚ˆã‚Šè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚"
