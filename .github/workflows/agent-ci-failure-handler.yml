name: CI Failure Handler

on:
  workflow_run:
    workflows: ["Desktop Build and Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'åˆ†æã—ãŸã„ Workflow Run ID (ç©ºæ¬„ã®å ´åˆã¯ç›´è¿‘ã®å¤±æ•—ã‚’åˆ†æ)'
        required: false
        default: ''

permissions:
  contents: read
  issues: write

jobs:
  on-failure:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'failure' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Determine Workflow Run ID
        id: info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT_ID="${{ github.event.inputs.run_id }}"
            if [ -z "$INPUT_ID" ]; then
              RUN_ID=$(gh run list --status failure --limit 1 --json databaseId --jq '.[0].databaseId')
            else
              RUN_ID=$INPUT_ID
            fi
          else
            RUN_ID=${{ github.event.workflow_run.id }}
          fi
          echo "RUN_ID=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Check for duplicate issue
        id: dedup
        env:
          GH_TOKEN: ${{ github.token }}
          WORKFLOW_ID: ${{ steps.info.outputs.RUN_ID }}
        run: |
          # Search for open issues that already reference this run ID
          COUNT=$(gh issue list --state open --search "Run #$WORKFLOW_ID" --json number --jq 'length')
          if [ "$COUNT" != "0" ]; then
            echo "Issue already exists for Run #$WORKFLOW_ID, skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Analyze logs and create issue
        if: steps.dedup.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          WORKFLOW_ID: ${{ steps.info.outputs.RUN_ID }}
          REPO: ${{ github.repository }}
        run: |
          echo "Fetching logs for workflow run: $WORKFLOW_ID"

          gh run view "$WORKFLOW_ID" --log-failed > failure_log.txt 2>&1 || true

          if [ ! -s failure_log.txt ]; then
            echo "ãƒ­ã‚°ãŒç©ºã®ãŸã‚ã€Issue ã®ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi

          # Extract error lines and surrounding context
          ERROR_LINES=$(grep -A 3 "##\[error\]" failure_log.txt | head -n 40 || true)
          LOG_TAIL=$(tail -n 60 failure_log.txt | head -n 50)

          # Get workflow metadata
          WORKFLOW_NAME=$(gh run view "$WORKFLOW_ID" --json name --jq '.name' 2>/dev/null || echo "Unknown")
          COMMIT_MSG="${{ github.event.workflow_run.head_commit.message }}"

          # Ensure labels exist (create if missing)
          gh label create "ci-failure" --color "D73A49" --description "CI/CD failure" 2>/dev/null || true

          gh issue create \
            --title "ğŸš¨ CI Failure: $WORKFLOW_NAME (Run #$WORKFLOW_ID)" \
            --label "ci-failure" \
            --body "$(cat <<EOF
## CI ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ

**Workflow**: \`$WORKFLOW_NAME\`
**Run ID**: [#$WORKFLOW_ID](https://github.com/$REPO/actions/runs/$WORKFLOW_ID)
**Commit**: $COMMIT_MSG

---

## ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°

\`\`\`
$ERROR_LINES
\`\`\`

<details>
<summary>ãƒ­ã‚°æœ«å°¾ï¼ˆè©³ç´°ï¼‰</summary>

\`\`\`
$LOG_TAIL
\`\`\`

</details>

[ğŸ“„ å®Œå…¨ãªãƒ­ã‚°ã‚’ç¢ºèª](https://github.com/$REPO/actions/runs/$WORKFLOW_ID)

---

## AI ã«ã‚ˆã‚‹è¨ºæ–­

GitHub Copilot Chat ã§ \`@ci-debugger\` ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ï¼š

\`\`\`
@ci-debugger Run #$WORKFLOW_ID ã®å¤±æ•—åŸå› ã‚’åˆ†æã—ã¦ã€ä¿®æ­£æ–¹æ³•ã‚’ææ¡ˆã—ã¦ãã ã•ã„
\`\`\`

---

*ã“ã® Issue ã¯ CI Failure Handler ã«ã‚ˆã‚Šè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚*
EOF
          )"
